<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>adacad-weaver documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">adacad-weaver documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">













<ol class="breadcrumb">
  <li>Interfaces</li>
  <li
  >
  DraftOperationClassification</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/player/player.service.ts</code>
        </p>




        <section>
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                        <a href="#category" 
>
                                            category
                                        </a>
                                </li>
                                <li>
                                        <a href="#category_id" 
>
                                            category_id
                                        </a>
                                </li>
                                <li>
                                        <a href="#dx" 
>
                                            dx
                                        </a>
                                </li>
                                <li>
                                        <a href="#ops" 
>
                                            ops
                                        </a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section>
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="category"></a>
                                        <span class="name "><b>category</b>
                                            <a href="#category">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>category:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="category_id"></a>
                                        <span class="name "><b>category_id</b>
                                            <a href="#category_id">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>category_id:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="dx"></a>
                                        <span class="name "><b>dx</b>
                                            <a href="#dx">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>dx:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="ops"></a>
                                        <span class="name "><b>ops</b>
                                            <a href="#ops">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>ops:         <code><a href="../miscellaneous/variables.html#layer" target="_self" >Array&lt;PlayerOp&gt;</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="../miscellaneous/variables.html#layer" target="_self" >Array&lt;PlayerOp&gt;</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Injectable} from &#x27;@angular/core&#x27;;
import { EventEmitter } from &#x27;events&#x27;;
import utilInstance from &#x27;../core/model/util&#x27;;
import { warps, wefts, flipDraft, initDraftWithParams } from &#x27;../core/model/drafts&#x27;;
import { Draft } from &#x27;../core/model/datatypes&#x27;;
import { BuildableOperation as GenericOp, OpInput, NumParam
} from &#x27;../mixer/model/operation&#x27;;
import * as defs from &#x27;../mixer/model/op_definitions&#x27;;
import { PlayerOp, OpTemplate as MenuOp, playerOpFrom, forward, refresh, reverse, SingleOpTemplate, CustomStructOp
} from &#x27;./model/playerop&#x27;;
import { PlayerState, WeavingPick, copyState } from &#x27;./model/state&#x27;;
import { MappingsService } from &#x27;./provider/mappings.service&#x27;;
import { PedalsService, Pedal } from &#x27;./provider/pedals.service&#x27;;
import { SequencerService } from &#x27;./provider/sequencer.service&#x27;;
import { PlaybackService } from &#x27;./provider/playback.service&#x27;;
import { SequencerMapping } from &#x27;./model/maptypes&#x27;;

export interface DraftOperationClassification {
  category_id: number,
  category: string,
  dx: string,
  ops: Array&lt;PlayerOp&gt; 
 }

interface LoomConfig {
  warps: number,
  draftTiling: boolean
}

/**
 * The Draft Player Service is in charge of updating the the global PlayerState and tracking where the weaver is in the draft.
 */
@Injectable({
  providedIn: &#x27;root&#x27;
})
export class PlayerService {
  loom: LoomConfig;
  redraw &#x3D; new EventEmitter();
  draftClassificationS: Array&lt;DraftOperationClassification&gt; &#x3D; [];
  draftClassificationT: Array&lt;DraftOperationClassification&gt; &#x3D; [];

  constructor(
    public pedals: PedalsService,
    public mappings: MappingsService, 
    public seq: SequencerService,
    public playback: PlaybackService,   // has the Player state
    // private oss: OperationService
  ) {

    this.loom &#x3D; { warps: 2640, draftTiling: true };

    // load the draft progress ops
    mappings.addMenuOperation(&lt;MenuOp&gt; forward);
    mappings.addMenuOperation(&lt;MenuOp&gt; refresh);
    mappings.addMenuOperation(&lt;MenuOp&gt; reverse);

    function addOp(op: GenericOp, params?: Array&lt;number | string&gt;) {
      let p_op &#x3D; params ? playerOpFrom(op, params) : playerOpFrom(op);
      mappings.addMenuOperation(p_op);
      return p_op;
    }

    // load ops from the main mixer
    const tabby &#x3D; addOp(defs.tabby);
    const twill &#x3D; addOp(defs.twill);
    const satin &#x3D; addOp(defs.satin);
    const waffle &#x3D; addOp(defs.waffle);
    const basket &#x3D; addOp(defs.basket);
    const rib &#x3D; addOp(defs.rib);
    const random &#x3D; addOp(defs.random);
    const rotate &#x3D; addOp(defs.rotate);
    const invert &#x3D; addOp(defs.invert);
    const shiftx &#x3D; addOp(defs.shiftx);
    const shifty &#x3D; addOp(defs.shifty);
    const slope &#x3D; addOp(defs.slope);
    const flipx &#x3D; addOp(defs.flipx);
    const flipy &#x3D; addOp(defs.flipy);
    const symm &#x3D; addOp(defs.makesymmetric);
    const stretch &#x3D; addOp(defs.stretch);
    const bindweft &#x3D; addOp(defs.bindweftfloats);
    const bindwarp &#x3D; addOp(defs.bindwarpfloats);
    const tile &#x3D; addOp(defs.tile);
    // : SingleOpBase &#x3D; {
    //   name: defs.tile.name,
    //   classifier: &#x27;pipe&#x27;,
    //   perform: (init: PlayerState) &#x3D;&gt; {
    //     let res &#x3D; copyState(init);
    //     res.draft &#x3D; defs.tile.perform([init.draft], [2, 2]);
    //     res.row &#x3D; init.row % wefts(res.draft.drawdown);
    //     res.pedal &#x3D; defs.tile.name;
    //     return Promise.resolve(res);
    //   }
    // }
    // mappings.addMenuOperation(tile);

    const chaos: SingleOpTemplate &#x3D; {
      id: -1,
      name: &#x27;chaos&#x27;,
      classifier: &#x27;pipe&#x27;,
      dx: &#x27;tiles the input drafts, randomly selecting which draft to place at which position&#x27;,
      params: &lt;Array&lt;NumParam&gt;&gt;[
        {
          name: &#x27;warp-repeats&#x27;,
          type: &#x27;number&#x27;,
          min: 1,
          max: 100,
          value: 2,
          dx: &#x27;the number of times to repeat this time across the width&#x27;
        }, {
          name: &#x27;weft-repeats&#x27;,
          type: &#x27;number&#x27;,
          min: 1,
          max: 100,
          value: 2,
          dx: &#x27;the number of times to repeat this time across the length&#x27;
        }
      ],
      perform: async (init: PlayerState) &#x3D;&gt; {
        const res &#x3D; copyState(init);
        const draft &#x3D; res.draft;

        const total_warps &#x3D; warps(draft.drawdown);
        // const total_warps &#x3D; utilInstance.lcm(all_warps);
        const total_wefts &#x3D; wefts(draft.drawdown);
        // const total_wefts &#x3D; utilInstance.lcm(all_wefts);

        const warp_repeats &#x3D; &lt;number&gt; chaos.params[0].value;
        const weft_repeats &#x3D; &lt;number&gt; chaos.params[1].value;

        const draft_indexing: Array&lt;Array&lt;Draft&gt;&gt; &#x3D; [];
        for(let i &#x3D; 0; i &lt; weft_repeats; i++){
          draft_indexing.push([]);
          for(let j &#x3D; 0; j &lt; warp_repeats; j++){
            const x_flip &#x3D; (Math.random() &lt; 0.5) ? false: true; 
            const y_flip &#x3D; (Math.random() &lt; 0.5) ? false: true; 
            draft_indexing[i].push(await flipDraft(draft, x_flip, y_flip));
          }
        }

        const width: number &#x3D; warp_repeats*total_warps;
        const height: number &#x3D; weft_repeats*total_wefts;
        const output: Draft &#x3D; initDraftWithParams({warps: width, wefts: height});

        output.drawdown.forEach((row, i) &#x3D;&gt; {
          let draft_index_row  &#x3D; Math.floor(i / total_wefts);
          let within_draft_row &#x3D; i % total_wefts;
          row.forEach((cell, j) &#x3D;&gt; {
            let draft_index_col  &#x3D; Math.floor(j / total_warps);
            let within_draft_col  &#x3D; j % total_warps;

            const draft &#x3D; draft_indexing[draft_index_row][draft_index_col];

            const w &#x3D; warps(draft.drawdown);
            const h &#x3D; wefts(draft.drawdown);
            cell.setHeddle(draft.drawdown[within_draft_row%w][within_draft_col%h].getHeddle()); 
          });
        });
      
        res.draft &#x3D; output;
        res.row &#x3D; init.row % wefts(res.draft.drawdown);
        res.pedal &#x3D; chaos.name;
        return Promise.resolve(res);
      }
    }
    mappings.addMenuOperation(chaos);

    this.draftClassificationS.push(
      { category_id: 0,
        category: &#x27;structure&#x27;,
        dx: &quot;0-1 input, 1 output, algorithmically generates weave structures based on parameters&quot;,
        ops: [tabby, twill, satin, waffle, random]}
    );

    this.draftClassificationS.push(
      { category_id: 1,
        category: &#x27;custom structure&#x27;,
        dx: &quot;custom structures loaded from the Mixer&quot;,
        ops: []
      }
    );

    this.draftClassificationT.push(
      { category_id: 2,
        category: &#x27;transformation&#x27;,
        dx: &quot;1 input, 1 output, applies an operation to the input that transforms it in some way&quot;,
        ops: [invert, flipx, flipy, shiftx, shifty, rotate, slope, stretch, symm, tile, chaos, bindwarp, bindweft]}
    );

    console.log(mappings.ops);

    // //test this
    // console.log(this.oss.getOp(&#x27;germanify&#x27;));
    // const germanify &#x3D; this.pedalOps.addOperation(playerOpFromTree(&lt;PlayableTreeOp&gt; this.oss.getOp(&#x27;germanify&#x27;)));
    
    console.log(&#x27;pedal ops added&#x27;);

    pedals.on(&#x27;pedal-step&#x27;, (id) &#x3D;&gt; this.onPedal(id));

    pedals.on(&#x27;pedal-added&#x27;, (n) &#x3D;&gt; {
      if (n &#x3D;&#x3D; 1) {
        mappings.pair(0, &#x27;forward&#x27;);
      } else if (n &#x3D;&#x3D; 2) {
        if (mappings.pedalIsMapped(0)) mappings.unmap(0);
        mappings.mapToSequencer(0, {role: &#x27;prog&#x27;, op_name: &#x27;forward&#x27;});
        mappings.mapToSequencer(1, {role: &#x27;sel&#x27;, dir: true, seq: mappings});
        this.seq.mapPedals(0, 1);
      } else if (n &#x3D;&#x3D; 3) {
        if (mappings.pedalIsMapped(0)) mappings.unmap(0);
        if (mappings.pedalIsMapped(1)) mappings.unmap(1);
        mappings.mapToSequencer(0, {role: &#x27;prog&#x27;, op_name: &#x27;forward&#x27;});
        mappings.mapToSequencer(1, {role: &#x27;sel&#x27;, dir: false, seq: mappings});
        mappings.mapToSequencer(2, {role: &#x27;sel&#x27;, dir: true, seq: mappings});
        this.seq.mapPedal(1, &#x27;sel-back&#x27;);
        this.seq.mapPedal(2, &#x27;sel-next&#x27;);
      }
      console.log(&quot;pedals mapping&quot;, mappings);
    })
    
    this.redraw.emit(&#x27;redraw&#x27;);
  }

  get readyToWeave() {  // need either one pedal forward or one pedal reverse, in order to progress through draft
    return (this.pedals.readyToWeave &amp;&amp; 
      (this.mappings.opIsMapped(&#x27;forward&#x27;) || this.mappings.opIsMapped(&#x27;reverse&#x27;) || this.seq.readyToWeave)
    );
  }

  get ops() { return this.mappings.ops; }
  get state() { return this.playback.state; }
  set state(s: PlayerState) { this.playback.setState(s); }

  /** get whether or not the loom is weaving */
  get weaving() {
    return this.pedals.active_draft.val as boolean;
  }
  get draft() {
    return this.state.draft;
  }

  hasCustomStructure(d: Draft): boolean {
    let ops &#x3D; this.draftClassificationS.filter((c) &#x3D;&gt; c.category &#x3D;&#x3D; &quot;custom structure&quot;)[0].ops;
    console.log(ops);
    if (ops.length &#x3D;&#x3D; 0) return false;
    return ops
      .map((el) &#x3D;&gt; { return (&lt;CustomStructOp&gt; el).struct_id &#x3D;&#x3D; d.id})
      .reduce((a, b) &#x3D;&gt; { return a || b; });
  }

  setDraft(d: Draft) {
    if (!this.hasCustomStructure(d)) {
      console.log(&quot;a new structure!&quot;);
      let structOps &#x3D; this.draftClassificationS.filter((c) &#x3D;&gt; c.category &#x3D;&#x3D; &quot;custom structure&quot;)[0].ops;
      let op &#x3D; this.structureOpFromDraft(d);
      structOps.push(op);
      this.mappings.addMenuOperation(&lt;MenuOp&gt; op);
    }
    this.state.draft &#x3D; d;
    this.state.row &#x3D; 0;
    console.log(&quot;draft set &quot;, this.state);
  }

  /**
   * 
   * @param d the Draft to turn into a custom structure Operation
   */
  structureOpFromDraft(d: Draft) {
    let structOp: CustomStructOp &#x3D; {
      id: d.id,
      name: d.gen_name,
      struct_id: d.id,
      params: [],
      custom_check: 1,
      classifier: &#x27;struct&#x27;,
      perform: (init: PlayerState) &#x3D;&gt; {
        let res &#x3D; copyState(init);
        res.draft &#x3D; d;
        res.row &#x3D; init.row % wefts(d.drawdown);
        return Promise.resolve(res);
      }
    };
    return structOp;
  }

  // e &#x3D; op.name
  setPedalOp(e: string, p: Pedal) {
    console.log(e, p);
    if (this.mappings.pedalIsPaired(p.id)) {
      this.mappings.unmap(p.id);
    }
    this.mappings.pair(p.id, e);
    console.log(&quot;pedals map&quot;, this.mappings);
  }

  onPedal(id: number) {
    console.log(&#x27;player service: pedal &#x27;, id);
    let mapped &#x3D; this.mappings.getMapByID(id);
    console.log(mapped);
    // console.log(this.mappings);
    // console.log(this.seq);
    if (mapped) {
      let performer;
      console.log(&#x27;mapping exists for pedal&#x27;);
      if ((&lt;SequencerMapping&gt; mapped).role) { performer &#x3D; this.seq; }
      else performer &#x3D; mapped;
      performer.perform(this.state, id)
      .then((state: PlayerState) &#x3D;&gt; {
        this.state &#x3D; state;
        // console.log(this.state);
        this.redraw.emit(&#x27;redraw&#x27;);
        if (this.state.weaving) {
          console.log(&quot;draft player: sending row&quot;);
          this.pedals.sendDraftRow(this.currentRow());
        }
      });
    }
  }

  currentRow() {
    let {draft, row} &#x3D; this.state;
    let draftRow &#x3D; draft.drawdown[row % wefts(draft.drawdown)];
    let data &#x3D; &quot;&quot;;

    let targetLength &#x3D; (this.loom.draftTiling ? this.loom.warps : draftRow.length);
    while (data.length &lt; targetLength) {
      for (var i in draftRow) {
        if (draftRow[i].is_up) {
          data +&#x3D; &#x27;1&#x27;;
        } else {
          data +&#x3D; &#x27;0&#x27;;
        }
      }
    }
    let pick: WeavingPick &#x3D; { pickNum: row, rowData: data };
    return pick;
  }

  toggleDraftTiling(e) {
    // console.log(&quot;toggle &quot;, e);
    this.loom.draftTiling &#x3D; e.checked;
    // console.log(&quot;draft tiling &quot;, this.loom.draftTiling);
  }

  changeLoomWidth(e) {
    // console.log(e.target.value);
    this.loom.warps &#x3D; e.target.value;
    // console.log(&quot;warps&quot;, this.loom.warps);
  }

  toggleWeaving() {
    // don&#x27;t let user start weaving until AT LEAST:
    // - 1 pedal connected AND
    // - 1 pedal configured with operation &quot;forward&quot; or &quot;reverse&quot;
    this.state.weaving &#x3D; !this.state.weaving;
    this.pedals.toggleWeaving();
    if (this.state.weaving) {
      // send the first row right away
      this.pedals.sendDraftRow(this.currentRow());
    }
  }
}
</code></pre>
    </div>
</div>








                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'DraftOperationClassification.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
